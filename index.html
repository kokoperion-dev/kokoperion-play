<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ココペリオン - ～星と森とココペリと～</title>
<style>
 body {
   margin: 0;
   padding: 0;
   background: black;
   overflow: hidden;
   font-family: sans-serif;
 }
 #game-area {
   position: relative;
   width: 100vw;
   height: 100vh;
   background-image: url('background.PNG');
   background-size: cover;
   background-position: center;
 }
 #kokopelli {
   position: absolute;
   top: 10%;
   left: 5%;
   width: 100px;
   z-index: 10;
   animation: float 3s ease-in-out infinite alternate;
 }
 @keyframes float {
   0% { transform: translateX(0); }
   50% { transform: translateX(20px); }
   100% { transform: translateX(-20px); }
 }
 #raccoon {
   position: absolute;
   bottom: 10%;
   left: 50%;
   transform: translateX(-50%);
   width: 120px;
   z-index: 10;
 }
 .star {
   position: absolute;
   width: 40px;
   animation: drop 4000ms linear, sway ease-in-out infinite, rotate 4s linear infinite;
   opacity: 0;
   transition: opacity 0.5s;
   z-index: 5;
 }
 .star.visible { opacity: 1; }
 @keyframes drop {
   from { top: 0; }
   to { top: 100%; }
 }
 @keyframes sway {
   0% { transform: translateX(0) rotate(0deg); }
   25% { transform: translateX(var(--sway-amplitude)) rotate(5deg); }
   50% { transform: translateX(0) rotate(0deg); }
   75% { transform: translateX(calc(-1 * var(--sway-amplitude))) rotate(-5deg); }
   100% { transform: translateX(0) rotate(0deg); }
 }
 @keyframes rotate {
   0% { transform: rotate(0deg); }
   100% { transform: rotate(360deg); }
 }
 #score-display, #timer-display, #stage-display {
   position: absolute;
   color: #fff;
   font-size: 24px;
   font-weight: bold;
   z-index: 999;
   background: rgba(0,0,0,0.7);
   padding: 6px 12px;
   border-radius: 10px;
   box-shadow: 0 0 6px rgba(0,0,0,0.8);
 }
 #score-display { top: 10px; right: 10px; }
 #timer-display { top: 10px; right: 170px; }
 #stage-display { top: 10px; left: 10px; }
 #message-overlay {
   position: absolute;
   top: 0; left: 0;
   width: 100%; height: 100%;
   background: rgba(0,0,0,0.8);
   color: white;
   z-index: 100;
   display: none;
   justify-content: center;
   align-items: center;
   flex-direction: column;
   text-align: center;
   padding: 20px;
 }
 #message-overlay h2 { color: #ffcc00; }
 #message-overlay button {
   font-size: 18px;
   padding: 10px 20px;
   margin: 10px;
   background: #4CAF50;
   color: white;
   border: none;
   border-radius: 5px;
   cursor: pointer;
 }
 #wisdom {
   font-style: italic;
   margin: 20px 0;
   color: #ffcc00;
   max-width: 80%;
   line-height: 1.6;
 }
</style>
</head>
<body>
<div id="game-area">
 <img id="kokopelli" src="kokopelli.PNG" alt="ココペリ">
 <img id="raccoon" src="raccoon.PNG" alt="アライグマ">
 <div id="score-display">スコア: <span id="score">0</span></div>
 <div id="timer-display">残り: <span id="timer">30</span>秒</div>
 <div id="stage-display">ステージ: <span id="stage">1</span></div>
</div>

<div id="message-overlay">
 <div id="message-content"></div>
 <div id="wisdom"></div>
 <button id="start-button" style="display:none;">スタート</button>
 <button id="next-button" style="display:none;">次へ</button>
 <button id="retry-button" style="display:none;">もう一度</button>
</div>

<audio id="sound-pop" src="star_pop.mp3"></audio>
<audio id="sound-catch" src="star_catch.mp3"></audio>
<audio id="sound-catch-rainbow" src="star_catch_rainbow.mp3"></audio>
<audio id="sound-catch-diamond" src="star_catch_diamond.mp3"></audio>
<audio id="bgm-clear" src="clear_bgm.mp3"></audio>
<audio id="bgm-fail" src="fail_bgm.mp3"></audio>
<audio id="bgm-main" src="main_bgm.mp3" loop></audio>

<script>
const stages = [
 { dropInterval: 2000, speed: 4000, goal: 12,
   starTypes: [
     { type: 'normal', prob: 0.9, score: 1, sound: 'sound-catch', img: 'star_normal.png' },
     { type: 'rainbow', prob: 0.1, score: 2, sound: 'sound-catch-rainbow', img: 'star_rainbow.png' }
   ]
 },
 { dropInterval: 1500, speed: 4000, goal: 25,
   starTypes: [
     { type: 'normal', prob: 0.5, score: 1, sound: 'sound-catch', img: 'star_normal.png' },
     { type: 'rainbow', prob: 0.4, score: 2, sound: 'sound-catch-rainbow', img: 'star_rainbow.png' },
     { type: 'diamond', prob: 0.1, score: 3, sound: 'sound-catch-diamond', img: 'star_diamond.png' }
   ]
 },
 { dropInterval: 1000, speed: 4000, goal: 55,
   starTypes: [
     { type: 'normal', prob: 0.1, score: 1, sound: 'sound-catch', img: 'star_normal.png' },
     { type: 'rainbow', prob: 0.5, score: 2, sound: 'sound-catch-rainbow', img: 'star_rainbow.png' },
     { type: 'diamond', prob: 0.4, score: 3, sound: 'sound-catch-diamond', img: 'star_diamond.png' }
   ]
 }
];

const nativeWisdom = [
 "大地は我らの母であり、全ての命はその子どもだ。",
 "風の歌を聴け、それは古の言葉を運んでくる。",
 "水は命の血、これを汚すことなかれ。",
 "星は夜の道しるべ、心の道も照らす。",
 "森は語る、耳を澄ませば答えが返る。",
 "火は友にも敵にもなる、扱い方を忘れるな。",
 "命あるもの全てに敬意を払え。",
 "大地の恵みは分かち合うことで豊かになる。",
 "急ぐ旅路も一歩ずつしか進めない。",
 "空は一つ、我らもまた一つ。",
 "川は絶えず流れ、時もまた同じく流れる。",
 "種を蒔けば花が咲く、心にも同じ。",
 "月は静かに満ち欠けを教える。",
 "石もまた物語を持つ。",
 "笑いは病を癒す薬だ。",
 "過去は学び、未来は育て、今を生きる。",
 "動物は我らの兄弟、共に暮らすべし。",
 "太陽の光は全ての者を平等に照らす。",
 "与えれば与えられる、それが自然の法だ。",
 "嵐の後には必ず虹がかかる。"
];

let stage = 0, score = 0, time = 30, interval, timer, running = false;
const raccoon = document.getElementById('raccoon');
const area = document.getElementById('game-area');
const scoreEl = document.getElementById('score');
const timerEl = document.getElementById('timer');
const stageEl = document.getElementById('stage');
const message = document.getElementById('message-overlay');
const messageContent = document.getElementById('message-content');
const wisdomEl = document.getElementById('wisdom');
const startButton = document.getElementById('start-button');
const nextButton = document.getElementById('next-button');
const retryButton = document.getElementById('retry-button');
const pop = document.getElementById('sound-pop');
const clearBgm = document.getElementById('bgm-clear');
const failBgm = document.getElementById('bgm-fail');
const mainBgm = document.getElementById('bgm-main');

function startGame() {
  score = 0;
  time = 30;
  currentStage = stages[stage];
  scoreEl.textContent = score;
  timerEl.textContent = time;
  stageEl.textContent = stage + 1;
  message.style.display = 'none';
  running = true;
  mainBgm.play();
  interval = setInterval(dropStar, currentStage.dropInterval);
  timer = setInterval(() => {
    time--;
    timerEl.textContent = time;
    if (time <= 0) endStage();
  }, 1000);
}

function dropStar() {
  const star = document.createElement('img');
  let rand = Math.random();
  let total = 0;
  let starData;
  for (let s of currentStage.starTypes) {
    total += s.prob;
    if (rand <= total) { starData = s; break; }
  }
  star.src = starData.img;
  star.classList.add('star', 'visible');
  star.style.left = Math.random() * (window.innerWidth - 40) + 'px';
  star.style.setProperty('--sway-amplitude', (Math.random() * 40 - 20) + 'px');
  star.style.animationDuration = currentStage.speed + 'ms';
  star.dataset.score = starData.score;
  star.dataset.sound = starData.sound;
  area.appendChild(star);
  setTimeout(() => { if (star.parentNode) star.remove(); }, currentStage.speed);
}

document.addEventListener('mousemove', e => {
  if (!running) return;
  raccoon.style.left = e.clientX - raccoon.offsetWidth / 2 + 'px';
});

setInterval(() => {
  if (!running) return;
  document.querySelectorAll('.star').forEach(star => {
    const starRect = star.getBoundingClientRect();
    const racRect = raccoon.getBoundingClientRect();
    if (!(starRect.bottom < racRect.top || starRect.top > racRect.bottom ||
          starRect.right < racRect.left || starRect.left > racRect.right)) {
      const snd = document.getElementById(star.dataset.sound);
      snd.currentTime = 0;
      snd.play();
      score += parseInt(star.dataset.score);
      scoreEl.textContent = score;
      star.remove();
    }
  });
}, 50);

function endStage() {
  running = false;
  clearInterval(interval);
  clearInterval(timer);
  mainBgm.pause();
  mainBgm.currentTime = 0;
  if (score >= currentStage.goal) {
    clearBgm.play();
    showMessage(`ステージ${stage + 1} クリア！<br>スコア: ${score}`, true);
  } else {
    failBgm.play();
    showMessage(`ステージ${stage + 1} 失敗…<br>スコア: ${score}`, false);
  }
}

function showMessage(text, success) {
  message.style.display = 'flex';
  messageContent.innerHTML = `<h2>${text}</h2>`;
  wisdomEl.textContent = nativeWisdom[Math.floor(Math.random() * nativeWisdom.length)];
  startButton.style.display = 'none';
  nextButton.style.display = success && stage < stages.length - 1 ? 'inline-block' : 'none';
  retryButton.style.display = !success || stage === stages.length - 1 ? 'inline-block' : 'none';
}

startButton.addEventListener('click', startGame);
nextButton.addEventListener('click', () => { stage++; startGame(); });
retryButton.addEventListener('click', () => { stage = 0; startGame(); });

window.onload = () => {
  message.style.display = 'flex';
  messageContent.innerHTML = `<h2>ココペリオンへようこそ！</h2>`;
  wisdomEl.textContent = nativeWisdom[Math.floor(Math.random() * nativeWisdom.length)];
  startButton.style.display = 'inline-block';
};
</script>
</body>
</html>
