<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ココペリオン - 知恵の星を集めよう</title>
 <style>
  body {
   margin: 0;
   padding: 0;
   background: black;
   overflow: hidden;
   font-family: sans-serif;
  }

  /* スタート画面 */
  #start-screen {
   position: fixed;
   top: 0;
   left: 0;
   width: 100vw;
   height: 100vh;
   background: url('background.PNG') center/cover;
   display: flex;
   flex-direction: column;
   justify-content: center;
   align-items: center;
   z-index: 1000;
   color: white;
   text-shadow: 0 0 10px black;
  }

  #start-title {
   font-size: 3rem;
   margin-bottom: 0;
   color: #ffcc00;
  }

  #start-button {
   padding: 15px 30px;
   font-size: 1.5rem;
   background: linear-gradient(to bottom, #4CAF50, #2E8B57);
   color: white;
   border: none;
   border-radius: 50px;
   cursor: pointer;
   margin-top: 30px;
   box-shadow: 0 5px 15px rgba(0,0,0,0.3);
   transition: all 0.3s;
  }

  #start-button:hover {
   transform: translateY(-3px);
   box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  }

  /* ゲーム画面 */
  #game-area {
   position: relative;
   width: 100vw;
   height: 100vh;
   background: url('background.PNG') center bottom 15%/cover;
   display: none;
  }

  /* アライグマ */
  #raccoon {
   position: absolute;
   bottom: 20%;
   width: 120px;
   z-index: 10;
   animation: 
    raccoonWalk 10s linear infinite,
    raccoonBounce 0.5s ease-in-out infinite alternate;
   transform-origin: center bottom;
  }

  @keyframes raccoonWalk {
    0% { left: -120px; transform: scaleX(1); }
    49% { transform: scaleX(1); }
    50% { left: calc(100% + 120px); transform: scaleX(-1); }
    100% { left: -120px; transform: scaleX(-1); }
  }

  @keyframes raccoonBounce {
    to { transform: translateY(-5px); }
  }

  /* スコア表示 */
  #score-display, #timer-display, #stage-display {
   position: absolute;
   color: white;
   font-size: 1.2rem;
   z-index: 100;
   background: rgba(0,0,0,0.7);
   padding: 10px 15px;
   border-radius: 10px;
   text-shadow: 0 0 5px black;
  }

  #score-display { top: 20px; right: 20px; }
  #timer-display { top: 20px; right: 180px; }
  #stage-display { top: 20px; left: 20px; }

  /* メッセージ画面 */
  #message-overlay {
   position: absolute;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background: rgba(0,0,0,0.8);
   color: white;
   z-index: 200;
   display: none;
   justify-content: center;
   align-items: center;
   flex-direction: column;
   text-align: center;
   padding: 20px;
  }

  #message-overlay h2 {
   color: #ffcc00;
   font-size: 2rem;
   margin-bottom: 20px;
  }

  #message-overlay button {
   font-size: 1.2rem;
   padding: 12px 25px;
   margin: 15px;
   background: linear-gradient(to bottom, #4CAF50, #2E8B57);
   color: white;
   border: none;
   border-radius: 50px;
   cursor: pointer;
   box-shadow: 0 5px 15px rgba(0,0,0,0.3);
   transition: all 0.3s;
  }

  #message-overlay button:hover {
   transform: translateY(-3px);
   box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  }

  #wisdom {
   font-style: italic;
   margin: 30px 0;
   color: #ffcc00;
   max-width: 80%;
   line-height: 1.6;
   font-size: 1.1rem;
  }
 </style>
</head>
<body>
 <!-- スタート画面 -->
 <div id="start-screen">
  <h1 id="start-title">ココペリオン</h1>
  <p>知恵の星を集めよう！</p>
  <button id="start-button">ゲームスタート</button>
 </div>

 <!-- ゲーム画面 -->
 <div id="game-area">
  <img id="kokopelli" src="kokopelli.PNG" alt="ココペリ">
  <img id="raccoon" src="raccoon.PNG" alt="アライグマ">
  <div id="score-display">スコア: <span id="score">0</span></div>
  <div id="timer-display">残り: <span id="timer">30</span>秒</div>
  <div id="stage-display">ステージ: <span id="stage">1</span></div>
 </div>

 <!-- メッセージ画面 -->
 <div id="message-overlay">
  <div id="message-content"></div>
  <div id="wisdom"></div>
  <button id="next-button">次へ</button>
  <button id="retry-button">もう一度</button>
 </div>

 <!-- 音声ファイル -->
 <audio id="sound-pop" src="star_pop.mp3"></audio>
 <audio id="sound-catch" src="star_catch.mp3"></audio>
 <audio id="sound-catch-rainbow" src="star_catch_rainbow.mp3"></audio>
 <audio id="sound-catch-diamond" src="star_catch_diamond.mp3"></audio>
 <audio id="bgm-clear" src="clear_bgm.mp3"></audio>
 <audio id="bgm-fail" src="fail_bgm.mp3"></audio>
 <audio id="bgm-main" src="main_bgm.mp3" loop></audio>

 <script>
  // ゲームデータ
  const stages = [ /* 既存のstages配列 */ ];
  const nativeWisdom = [ /* 既存のnativeWisdom配列 */ ];

  // ゲーム変数
  let stage = 0, score = 0, time = 30, interval, timer, running = false;
  let currentStage = stages[stage];

  // DOM要素
  const startScreen = document.getElementById('start-screen');
  const startButton = document.getElementById('start-button');
  const gameArea = document.getElementById('game-area');
  const raccoon = document.getElementById('raccoon');
  const scoreEl = document.getElementById('score');
  const timerEl = document.getElementById('timer');
  const stageEl = document.getElementById('stage');
  const message = document.getElementById('message-overlay');
  const messageContent = document.getElementById('message-content');
  const wisdomEl = document.getElementById('wisdom');
  const nextButton = document.getElementById('next-button');
  const retryButton = document.getElementById('retry-button');
  const mainBgm = document.getElementById('bgm-main');

  // スタートボタン処理
  startButton.addEventListener('click', () => {
   startScreen.style.display = 'none';
   gameArea.style.display = 'block';
   
   // BGM再生
   mainBgm.currentTime = 0;
   mainBgm.play().catch(e => console.error("BGM Error:", e));
   
   startStage();
  });

  // 既存のゲーム関数（startStage, endStage, spawnStarなど）
  // ...（すべての既存ゲームロジックをここに保持）...

  // イベントリスナー
  nextButton.addEventListener('click', () => { 
   stage++; 
   startStage(); 
  });
  
  retryButton.addEventListener('click', startStage);

  // タッチ/マウス操作
  let touchStartX = 0;
  let raccoonStartX = 0;

  window.addEventListener('touchstart', (e) => {
   if (!running) return;
   touchStartX = e.touches[0].clientX;
   raccoonStartX = raccoon.offsetLeft;
  });

  window.addEventListener('touchmove', (e) => {
   if (!running) return;
   const touchX = e.touches[0].clientX;
   const deltaX = touchX - touchStartX;
   let newLeft = raccoonStartX + deltaX;
    
   newLeft = Math.max(0, Math.min(window.innerWidth - raccoon.offsetWidth, newLeft));
   raccoon.style.left = `${newLeft}px`;
   raccoon.style.transform = 'translateX(0)';
  });

  // PC用マウス操作
  let isDragging = false;
  let mouseStartX = 0;
  let mouseRaccoonStartX = 0;

  raccoon.addEventListener('mousedown', (e) => {
   if (!running) return;
   isDragging = true;
   mouseStartX = e.clientX;
   mouseRaccoonStartX = raccoon.offsetLeft;
   e.preventDefault();
  });

  window.addEventListener('mousemove', (e) => {
   if (!isDragging || !running) return;
   const deltaX = e.clientX - mouseStartX;
   let newLeft = mouseRaccoonStartX + deltaX;
    
   newLeft = Math.max(0, Math.min(window.innerWidth - raccoon.offsetWidth, newLeft));
   raccoon.style.left = `${newLeft}px`;
  });

  window.addEventListener('mouseup', () => {
   isDragging = false;
  });
 </script>
</body>
</html>
