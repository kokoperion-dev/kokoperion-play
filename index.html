<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ココペリオン - 完全版</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0a0e17;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      touch-action: pan-y;
    }
    #game-area {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d);
      overflow: hidden;
    }
    #kokopelli {
      position: absolute;
      top: 15%;
      left: 5%;
      width: 80px;
      z-index: 10;
      animation: float 5s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 5px rgba(255,255,200,0.5));
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(-3deg); }
      50% { transform: translateY(-15px) rotate(3deg); }
    }
    #raccoon {
      position: absolute;
      bottom: 12%;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      z-index: 15;
      user-select: none;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 0 8px rgba(255,255,200,0.3));
    }
    .star {
      position: absolute;
      width: 30px;
      height: 30px;
      animation: 
        drop 5s linear forwards,
        sway 8s linear infinite;
      opacity: 0;
      transition: opacity 0.5s ease-out;
      z-index: 10;
      pointer-events: auto;
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
    }
    .star.visible { opacity: 1; }
    .star.rainbow {
      width: 40px;
      height: 40px;
      filter: drop-shadow(0 0 10px rgba(255,100,255,0.6));
    }
    .star.diamond {
      width: 35px;
      height: 35px;
      filter: drop-shadow(0 0 15px rgba(100,255,255,0.7));
    }
    @keyframes drop {
      from { top: -50px; opacity: 0; }
      10% { opacity: 1; }
      to { top: 100vh; }
    }
    @keyframes sway {
      0% { transform: translateX(0); }
      25% { transform: translateX(var(--sway-amplitude)); }
      50% { transform: translateX(var(--sway-amplitude)); }
      75% { transform: translateX(calc(-1 * var(--sway-amplitude))); }
      100% { transform: translateX(calc(-1 * var(--sway-amplitude))); }
    }
    /* スコア表示などのスタイルは変更なし */
  </style>
</head>
<body>
  <div id="game-area">
    <img id="kokopelli" src="kokopelli.png" onerror="this.src='kokopelli.PNG'" alt="ココペリ">
    <div id="score-display">スコア: <span id="score">0</span></div>
    <div id="timer-display">残り: <span id="timer">30</span>秒</div>
    <div id="stage-display">ステージ: <span id="stage">1</span></div>
    <img id="raccoon" src="raccoon.png" onerror="this.src='raccoon.PNG'" alt="アライグマ">
  </div>

  <div id="message-overlay">
    <div id="message-content"></div>
    <button id="next-button">次へ</button>
    <button id="retry-button">もう一度</button>
  </div>

  <!-- 音声ファイル -->
  <audio id="sound-pop" src="star_pop.mp3"></audio>
  <audio id="sound-catch" src="star_catch.mp3"></audio>
  <audio id="sound-catch-rainbow" src="star_catch_rainbow.mp3"></audio>
  <audio id="sound-catch-diamond" src="star_catch_diamond.mp3"></audio>
  <audio id="bgm-clear" src="clear_bgm.mp3"></audio>
  <audio id="bgm-fail" src="fail_bgm.mp3"></audio>

  <script>
    // ゲーム設定
    const stages = [
      { 
        dropInterval: 2000,
        speed: 5000,
        goal: 15,
        starTypes: [
          { type: 'normal', prob: 0.9, score: 1, sound: 'sound-catch', img: 'star_normal.png' },
          { type: 'rainbow', prob: 0.1, score: 2, sound: 'sound-catch-rainbow', img: 'star_rainbow.png' }
        ]
      },
      { 
        dropInterval: 1500,
        speed: 5000,
        goal: 40,
        starTypes: [
          { type: 'normal', prob: 0.5, score: 1, sound: 'sound-catch', img: 'star_normal.png' },
          { type: 'rainbow', prob: 0.4, score: 2, sound: 'sound-catch-rainbow', img: 'star_rainbow.png' },
          { type: 'diamond', prob: 0.1, score: 3, sound: 'sound-catch-diamond', img: 'diamond.png' }
        ]
      },
      { 
        dropInterval: 1000,
        speed: 5000,
        goal: 60,
        starTypes: [
          { type: 'normal', prob: 0.1, score: 1, sound: 'sound-catch', img: 'star_normal.png' },
          { type: 'rainbow', prob: 0.5, score: 2, sound: 'sound-catch-rainbow', img: 'star_rainbow.png' },
          { type: 'diamond', prob: 0.4, score: 3, sound: 'sound-catch-diamond', img: 'diamond.png' }
        ]
      }
    ];

    // ゲーム変数とDOM要素
    let stage = 0, score = 0, time = 30;
    let interval, timer, running = false;
    const raccoon = document.getElementById('raccoon');
    const area = document.getElementById('game-area');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const stageEl = document.getElementById('stage');
    const message = document.getElementById('message-overlay');
    const messageContent = document.getElementById('message-content');
    const nextButton = document.getElementById('next-button');
    const retryButton = document.getElementById('retry-button');

    // 星生成関数
    function spawnStar() {
      const star = document.createElement('img');
      const currentStage = stages[stage];
      const rand = Math.random();
      let cumulativeProb = 0;
      let selectedType;

      for (const type of currentStage.starTypes) {
        cumulativeProb += type.prob;
        if (rand <= cumulativeProb) {
          selectedType = type;
          break;
        }
      }

      star.src = selectedType.img;
      star.onerror = () => star.src = selectedType.img.replace('.png', '.PNG');
      star.className = `star visible ${selectedType.type}`;
      
      // アニメーション設定
      const swayAmplitude = 40; // 揺れ幅40px固定
      star.style.cssText = `
        left: ${Math.random() * (window.innerWidth - 50)}px;
        --sway-amplitude: ${swayAmplitude}px;
        animation: 
          drop ${currentStage.speed}ms linear forwards,
          sway 8s linear infinite;
      `;
      
      area.appendChild(star);
      document.getElementById('sound-pop').play();
      
      // 当たり判定
      star.addEventListener('click', () => {
        score += selectedType.score;
        scoreEl.textContent = score;
        document.getElementById(selectedType.sound).play();
        star.style.opacity = '0';
        setTimeout(() => star.remove(), 300);
      });
    }

    // その他のゲーム関数（startStage, endStage等）は変更なし
    window.onload = () => {
      document.getElementById('kokopelli').onerror = function() {
        this.src = 'kokopelli.PNG';
      };
      document.getElementById('raccoon').onerror = function() {
        this.src = 'raccoon.PNG';
      };
      startStage();
    };
  </script>
</body>
</html>
